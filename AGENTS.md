## Project Overview

This is a SvelteKit application using Svelte 5 with TypeScript. It implements an authenticated web application with a logbook/tracking system. The tech stack includes:

- **Framework**: SvelteKit with Svelte 5 (using runes and experimental features)
- **Database**: Turso (libSQL) via Drizzle ORM
- **Authentication**: Better Auth with email/password
- **UI Components**: shadcn-svelte with TailwindCSS v4
- **Testing**: Vitest with Playwright browser testing
- **Package Manager**: bun

## Development Commands

### Core Development

```bash
bun dev              # Start development server
bun build            # Build for production
bun preview          # Preview production build
bun check            # Type-check with svelte-check
bun check:watch      # Type-check in watch mode
```

### Testing

```bash
bun test             # Run all tests once
bun test:unit        # Run tests in watch mode
```

The test setup uses two projects:

- **Client tests**: Browser-based tests for Svelte components (`.svelte.spec.ts` or `.svelte.test.ts`)
- **Server tests**: Node-based tests for server code (`.spec.ts` or `.test.ts`)

### Database Operations

```bash
bun db:local         # Start local Turso database (at .db/local.db)
bun db:push          # Push schema changes to database
bun db:generate      # Generate migrations
bun db:migrate       # Apply migrations
bun db:studio        # Open Drizzle Studio
```

**Important**: Always run `bun db:local` first when developing locally. This starts the local Turso database server at `http://127.0.0.1:8080`.

### Code Quality

```bash
bun lint             # Run ESLint and Prettier checks
bun format           # Format code with Prettier
```

### UI Components

```bash
bun shadcn           # Add new shadcn-svelte components
bun auth             # Better Auth CLI
bun auth:generate    # Generate auth schema at src/lib/server/db/schema/auth.ts
```

## Architecture

### Authentication Flow

The application uses Better Auth with a custom email/password provider. Key components:

- **Auth Configuration** (`src/lib/auth.ts`): Configures Better Auth with Drizzle adapter, email verification, and SvelteKit cookies plugin
- **Server Hook** (`src/hooks.server.ts`): Handles session management by attaching `session` and `user` to `event.locals` on every request
- **Type Augmentation** (`src/app.d.ts`): Extends `App.Locals` to include session and user types

**Route Structure**:

- `(authed)` route group: Protected routes requiring authentication
  - Layout server load (`+layout.server.ts`) redirects to `/sign-in` if no session
- `(unauthed)` route group: Public routes (`/sign-in`, `/sign-up`)

### Database Schema

Located in `src/lib/server/db/schema/`:

- **auth.ts**: Auto-generated by Better Auth (user, session, account, verification tables)
- **index.ts**: Re-exports auth schema and will contain custom application tables

The database connection is initialized in `src/lib/server/db/index.ts` using Drizzle ORM with libSQL driver.

**Schema Configuration** (`drizzle.config.ts`):

- Uses Turso dialect
- Schema files: Currently points to old paths that should be updated to `./src/lib/server/db/schema/*.ts`
- Requires `DATABASE_URL` environment variable

### SvelteKit Configuration

**Experimental Features Enabled** (`svelte.config.js`):

- `remoteFunctions: true` - Allows server functions to be called from client
- `async: true` - Compiler support for async/await in Svelte components

### UI Component System

Uses shadcn-svelte components (configured in `components.json`):

- Base color: slate
- Components location: `$lib/components/ui/`
- Custom components: `$lib/components/` (app-sidebar, nav-\*, signin-form, signup-form, mode-selector)

TailwindCSS v4 is configured via Vite plugin (not traditional config file).

### Environment Variables

Required (see `.env.example`):

```
BETTER_AUTH_SECRET=          # Generate with: openssl rand -base64 32
BETTER_AUTH_URL=             # App URL (http://localhost:5173 for dev)
DATABASE_URL=                # http://127.0.0.1:8080 for local dev
DATABASE_AUTH_TOKEN=         # Empty for local dev
```

## Key Implementation Details

### Type Safety

- Svelte 5 uses runes (`$state`, `$derived`, `$effect`) instead of stores for reactivity
- Better Auth types are inferred via `typeof auth.$Infer.Session`
- User and Session types exported from `src/lib/auth.ts`

### Email Verification

Currently logs verification links to console (see `src/lib/auth.ts:16-21`). In production, implement proper email sending via `sendVerificationEmail` callback.

### Route Protection

Protected routes use the `(authed)` route group with a layout server load function that validates session presence. This pattern ensures all nested routes inherit authentication requirements.

### Database Workflow

1. Start local Turso: `pnpm db:local`
2. Modify schema in `src/lib/server/db/schema/`
3. Push changes: `pnpm db:push` (dev) or `pnpm db:generate` + `pnpm db:migrate` (production)
4. Access database via `import { db } from '$lib/server/db'`

### Logbook page

This is the logbook page structure based on the Jeppesen EU logbook:

| Date | Departure_Place | Departure_Time | Arrival_Place | Arrival_Time | Aircraft_Name | Aircraft_Model | Aircraft_Variant | Aircraft_Registration | Aircraft_Category | Single_Pilot_Time | Multi_Pilot_Time | Total_Time_Of_Flight | Name_PIC | Takeoffs_Day | Takeoffs_Night | Landings_Day | Landings_Night | Operational_Night | Operational_IFR | PIC_Time | Dual_Time | Co_Pilot_Time | Instructor_Time | Synthetic_Training_Type | Remarks_And_Endorsements |
| ---- | --------------- | -------------- | ------------- | ------------ | ------------- | -------------- | ---------------- | --------------------- | ----------------- | ----------------- | ---------------- | -------------------- | -------- | ------------ | -------------- | ------------ | -------------- | ----------------- | --------------- | -------- | --------- | ------------- | --------------- | ----------------------- | ------------------------ |
|      |                 |                |               |              |               |                |                  |                       |                   |                   |                  |                      |          |              |                |              |                |                   |                 |          |           |               |                 |                         |                          |
